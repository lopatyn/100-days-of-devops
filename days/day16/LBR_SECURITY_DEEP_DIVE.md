# –ì–ª–∏–±–æ–∫–∏–π —Ä–æ–∑–±—ñ—Ä: –ó–∞—Ö–∏—Å—Ç —Ç–∞ –í—ñ–¥–º–æ–≤–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å LBR üõ°Ô∏è‚öñÔ∏è

## 1. –û–±–º–µ–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `limit_req`

–£ –≤–∏—Ä–æ–±–Ω–∏—á–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –≤–∞—à –±–∞–ª–∞–Ω—Å—É–≤–∞–ª—å–Ω–∏–∫ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Äî —Ü–µ –ø–µ—Ä—à–∞ –ª—ñ–Ω—ñ—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ DDoS-–∞—Ç–∞–∫ –Ω–∞ —Ä—ñ–≤–Ω—ñ –¥–æ–¥–∞—Ç–∫—ñ–≤ –∞–±–æ –ø–æ–º–∏–ª–æ–∫ —É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç—ñ–≤. –ú–æ–¥—É–ª—å Nginx `limit_req` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∞–ª–≥–æ—Ä–∏—Ç–º **"Leaky Bucket"** (–¥—ñ—Ä—è–≤–µ –≤—ñ–¥—Ä–æ) –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é –±–µ–∫–µ–Ω–¥—ñ–≤.

### –†–æ–∑–±—ñ—Ä –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
–î–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –≤–∏ —Å–ø–æ—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á–∞—î—Ç–µ –∑–æ–Ω—É —Å–ø—ñ–ª—å–Ω–æ—ó –ø–∞–º'—è—Ç—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—ñ–≤, –∞ –ø–æ—Ç—ñ–º –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç–µ —ó—ó –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ª–æ–∫–∞—Ü—ñ–π.

```nginx
# –í–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ 'http'
limit_req_zone $binary_remote_addr zone=mylimit:10m rate=5r/s;

server {
    location / {
        # burst: –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–æ—Ç–∫–æ—á–∞—Å–Ω—ñ —Å–ø–ª–µ—Å–∫–∏ –¥–æ 10 –∑–∞–ø–∏—Ç—ñ–≤
        # nodelay: –æ–±—Ä–æ–±–ª—è—î burst-–∑–∞–ø–∏—Ç–∏ –Ω–µ–≥–∞–π–Ω–æ (–∫–æ—Ä–∏—Å–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ UX)
        limit_req zone=mylimit burst=10 nodelay;
        
        proxy_pass http://stapp;
    }
}
```

- **`$binary_remote_addr`**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î IP –∫–ª—ñ—î–Ω—Ç–∞ –≤ –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ (–∑–∞–π–º–∞—î –ª–∏—à–µ 32 –±–∞–π—Ç–∏ –¥–ª—è IPv4), —â–æ –Ω–∞–±–∞–≥–∞—Ç–æ –µ–∫–æ–Ω–æ–º–Ω—ñ—à–µ –¥–ª—è –ø–∞–º'—è—Ç—ñ, –Ω—ñ–∂ —Ä—è–¥–∫–æ–≤–∏–π `$remote_addr`.
- **`5r/s`**: –í—ñ–¥—Ö–∏–ª—è—î –∑–∞–ø–∏—Ç–∏, —è–∫—â–æ –≤–æ–Ω–∏ –ø–µ—Ä–µ–≤–∏—â—É—é—Ç—å 5 –Ω–∞ —Å–µ–∫—É–Ω–¥—É –∑ –æ–¥–Ω—ñ—î—ó IP-–∞–¥—Ä–µ—Å–∏.
- **–ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ:** –¶–µ –∑–º—É—à—É—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–ª—å—à–µ IP-–∞–¥—Ä–µ—Å (—Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∞ –∞—Ç–∞–∫–∞) —Ç–∞ –∑–∞—Ö–∏—â–∞—î –ø—É–ª–∏ –∑'—î–¥–Ω–∞–Ω—å –±–µ–∫–µ–Ω–¥–∞ –≤—ñ–¥ –≤–∏—á–µ—Ä–ø–∞–Ω–Ω—è –æ–¥–Ω–∏–º —à–∫—ñ–¥–ª–∏–≤–∏–º –∞–∫—Ç–æ—Ä–æ–º.

---

## 2. –£—Å—É–Ω–µ–Ω–Ω—è —î–¥–∏–Ω–æ—ó —Ç–æ—á–∫–∏ –≤—ñ–¥–º–æ–≤–∏ (SPOF)

–°–∞–º –±–∞–ª–∞–Ω—Å—É–≤–∞–ª—å–Ω–∏–∫ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—î –±—É—Ç–∏ –≤–∏—Å–æ–∫–æ–Ω–∞–¥—ñ–π–Ω–∏–º. –Ø–∫—â–æ –≤—É–∑–æ–ª LBR –≤–∏–π–¥–µ –∑ –ª–∞–¥—É, –≤–µ—Å—å —Å—Ç–µ–∫ —Å—Ç–∞–Ω–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–º.

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä

| –§—É–Ω–∫—Ü—ñ—è | On-Premise (–ó–∞–ª—ñ–∑–æ/VMs) | Cloud-Native (AWS/Azure/GCP) |
| :--- | :--- | :--- |
| **–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏** | **Keepalived** + VRRP | Managed LB (–Ω–∞–ø—Ä. **AWS ALB**) |
| **–õ–æ–≥—ñ–∫–∞** | –î–≤–∞ LBR —Ä–æ–∑–¥—ñ–ª—è—é—Ç—å **–≤—ñ—Ä—Ç—É–∞–ª—å–Ω—É IP (VIP)**. | LB —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏–π –º—ñ–∂ –¥–µ–∫—ñ–ª—å–∫–æ–º–∞ **–∑–æ–Ω–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ**. |
| **Failover** | –†–µ–∑–µ—Ä–≤–Ω–∏–π –≤—É–∑–æ–ª –º–∏—Ç—Ç—î–≤–æ –∑–∞–±–∏—Ä–∞—î VIP, —è–∫—â–æ Master "–ø–∞–¥–∞—î". | DNS –≤–∫–∞–∑—É—î –Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞ IP, –∫–µ—Ä–æ–≤–∞–Ω–∏—Ö —Ö–º–∞—Ä–Ω–∏–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º. |
| **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å** | –†—É—á–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è "–ø—É–ª—å—Å—É" —Ç–∞ —Å–∫—Ä–∏–ø—Ç—ñ–≤ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è. | –ü—Ä–∏–Ω—Ü–∏–ø "–Ω–∞–ª–∞—à—Ç—É–≤–∞–≤ —ñ –∑–∞–±—É–≤" –∑ –≤–±—É–¥–æ–≤–∞–Ω–∏–º–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏ –∑–¥–æ—Ä–æ–≤'—è. |

### White Hat Challenge: –û–±—Ö—ñ–¥ —á–µ—Ä–µ–∑ "–ü—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø" üïµÔ∏è‚Äç‚ôÇÔ∏è
–ó–∞—Ö–∏—Å—Ç –Ω–∞ —Ä—ñ–≤–Ω—ñ LBR –º–∞—Ä–Ω–∏–π, —è–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ App-—Å–µ—Ä–≤–µ—Ä—ñ–≤ –Ω–∞–ø—Ä—è–º—É.
1. **–Ü–∑–æ–ª—è—Ü—ñ—è –º–µ—Ä–µ–∂—ñ:** –°–µ—Ä–≤–µ—Ä–∏ –¥–æ–¥–∞—Ç–∫—ñ–≤ –º–∞—é—Ç—å –ø—Ä–∏–π–º–∞—Ç–∏ —Ç—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Å–≤–æ—ó –ø–æ—Ä—Ç–∏ (–Ω–∞–ø—Ä. 8083) –¢–Ü–õ–¨–ö–ò –∑ IP-–∞–¥—Ä–µ—Å–∏ LBR.
2. **–í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `iptables` –∞–±–æ —Ö–º–∞—Ä–Ω—ñ Security Groups, —â–æ–± —Å–∫–∏–¥–∞—Ç–∏ –≤–µ—Å—å —Ç—Ä–∞—Ñ—ñ–∫ –Ω–∞ –ø–æ—Ä—Ç 8083, —è–∫—â–æ –¥–∂–µ—Ä–µ–ª–æ–º –Ω–µ —î LBR.

```bash
# –ü—Ä–∏–∫–ª–∞–¥ –∑–∞—Ö–∏—Å–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ stapp01
sudo iptables -A INPUT -p tcp -s 172.16.238.14 --dport 8083 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8083 -j DROP
```

---

## 4. –°–µ—Å—ñ–π–Ω—ñ—Å—Ç—å —Ç–∞ Sticky Sessions

–ö–æ–ª–∏ —Ç–∏ –ø—Ä–∞—Ü—é—î—à –∑ –∫–ª–∞—Å—Ç–µ—Ä–æ–º —Å–µ—Ä–≤–µ—Ä—ñ–≤, –≤–∏–Ω–∏–∫–∞—î –ø—Ä–æ–±–ª–µ–º–∞ **Persistence (–°—Ç–∞–ª—ñ—Å—Ç—å)**.

### –ü—Ä–æ–±–ª–µ–º–∞
–ë—ñ–ª—å—à—ñ—Å—Ç—å –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å –¥–∞–Ω—ñ —Å–µ—Å—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å—Ç–∞–Ω "–∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–æ–≥–æ" –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ –∫–æ—à–∏–∫ –ø–æ–∫—É–ø–æ–∫) –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (—É –ø–∞–º'—è—Ç—ñ –∞–±–æ —Ñ–∞–π–ª–∞—Ö `/tmp`).
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–æ–≥—ñ–Ω–∏–≤—Å—è –Ω–∞ `stapp01`. –ô–æ–≥–æ —Å–µ—Å—ñ—è —Ç–∞–º.
- –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫–ª—ñ–∫ ‚Äî Nginx (–∑–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º Round Robin) –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç –Ω–∞ `stapp02`.
- `stapp02` –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞—î –ø—Ä–æ —Ü—é —Å–µ—Å—ñ—é -> –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ "–≤–∏–∫–∏–¥–∞—î" –∑ —Å–∏—Å—Ç–µ–º–∏ (Session Loss).

### –†—ñ—à–µ–Ω–Ω—è 1: Sticky Sessions (IP Hash)
–ù–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π —Å–ø–æ—Å—ñ–± –≤ Nginx ‚Äî –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏, —â–æ–± –æ–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π –∫–ª—ñ—î–Ω—Ç –∑–∞–≤–∂–¥–∏ –ø–æ—Ç—Ä–∞–ø–ª—è–≤ –Ω–∞ –æ–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π —Å–µ—Ä–≤–µ—Ä.

```nginx
upstream stapp {
    ip_hash; # –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ –ø–µ–≤–Ω–∏–º IP –∑–∞–≤–∂–¥–∏ –±—É–¥–µ "–ø—Ä–∏–≤'—è–∑–∞–Ω–∏–π" –¥–æ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
    server stapp01:8083;
    server stapp02:8083;
    server stapp03:8083;
}
```
**–ú—ñ–Ω—É—Å:** –Ø–∫—â–æ –≤–µ–ª–∏–∫–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤–∏—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∏–π NAT (–æ–¥–∏–Ω –∑–æ–≤–Ω—ñ—à–Ω—ñ–π IP), –≤—Å—ñ –≤–æ–Ω–∏ –ø–æ—Ç—Ä–∞–ø–ª—è—Ç—å –Ω–∞ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä, —â–æ —Å–ø—Ä–∏—á–∏–Ω–∏—Ç—å –¥–∏—Å–±–∞–ª–∞–Ω—Å –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

### –†—ñ—à–µ–Ω–Ω—è 2: –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–µ —Å—Ö–æ–≤–∏—â–µ (DevOps Way)
–ó–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –Ω–∞–º–∞–≥–∞—Ç–∏—Å—è "–ø—Ä–∏–≤'—è–∑–∞—Ç–∏" –∫–ª—ñ—î–Ω—Ç–∞ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞, –º–∏ —Ä–æ–±–∏–º–æ —Å–µ—Ä–≤–µ—Ä–∏ **Stateless** (–±–µ–∑ —Å—Ç–∞–Ω—É).
- –î–∞–Ω—ñ —Å–µ—Å—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –±–∞–∑—ñ –¥–∞–Ω–∏—Ö (–Ω–∞–ø—Ä. **Redis** –∞–±–æ **Memcached**).
- –ë—É–¥—å-—è–∫–∏–π —Å–µ—Ä–≤–µ—Ä –∑ –∫–ª–∞—Å—Ç–µ—Ä—É –º–æ–∂–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Å–µ—Å—ñ—é –∑ Redis –∑–∞ ID, —â–æ –ø—Ä–∏–π—à–æ–≤ —É Cookie.
- –¶–µ –¥–æ–∑–≤–æ–ª—è—î –±–∞–ª–∞–Ω—Å—É–≤–∞–ª—å–Ω–∏–∫—É –≤—ñ–ª—å–Ω–æ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—Ç–∏ —Ç—Ä–∞—Ñ—ñ–∫, –Ω–µ –±–æ—è—á–∏—Å—å –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö.

---

## 5. –ù–∞–π–∫—Ä–∞—â—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏—Ö LBR
- **–õ–æ–≥—É–≤–∞–Ω–Ω—è:** –ó–∞–≤–∂–¥–∏ –ª–æ–≥—É–π—Ç–µ `$remote_addr` –¢–ê –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Forwarded-For`.
- **–ü–∞—Å–∏–≤–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (Health Checks):** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `max_fails=3 fail_timeout=30s` —É –±–ª–æ—Ü—ñ `upstream`, —â–æ–± Nginx –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ–≥–Ω–æ—Ä—É–≤–∞–≤ "–º–µ—Ä—Ç–≤—ñ" –±–µ–∫–µ–Ω–¥–∏.
- **–¢–∞–π–º–∞—É—Ç–∏:** –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `proxy_connect_timeout` —Ç–∞ `proxy_read_timeout` –∑–∞–ø–æ–±—ñ–≥–∞—î –±–ª–æ–∫—É–≤–∞–Ω–Ω—é —Ä–æ–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤ LBR –ø–æ–≤—ñ–ª—å–Ω–∏–º –±–µ–∫–µ–Ω–¥–æ–º.

---
üîó **–ù–∞–∑–∞–¥ –¥–æ:** [–ó–≤—ñ—Ç –∑–∞ –î–µ–Ω—å 16](./README.md)
